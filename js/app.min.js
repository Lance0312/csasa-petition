function checkKeyStrokes(e,t){return e&&t?e.length!==t.length?!1:(e.forEach(function(e,r){return e!==t[r]?!1:void 0}),!0):!1}function midAngle(e){return e.startAngle+(e.endAngle-e.startAngle)/2}function renderPieChart(e,t){renderPieSlices(e,t),renderTextLabels(e,t),renderTextPolylines(e,t)}function renderPieSlices(e,t){var r=e.select(".slices").selectAll("path.slice").data(pie(t),function(e){return e.data.key});r.enter().insert("path").style("fill",function(e){return sliceColors[e.data.key]}).attr("class","slice"),r.transition().duration(1e3).attrTween("d",function(e){this._current=this._current||e;var t=d3.interpolate(this._current,e);return this._current=t(0),function(e){return innerArc(t(e))}}),r.exit().remove()}function renderTextLabels(e,t){var r=e.select(".labels").selectAll("text").data(pie(t),function(e){return e.data.key});r.enter().append("text").attr("dy",".35em").text(function(e){return e.value+" 席"}),r.transition().duration(1e3).attrTween("transform",function(e){this._current=this._current||e;var t=d3.interpolate(this._current,e);return this._current=t(0),function(e){var r=t(e),n=outerArc.centroid(r);return n[0]=.95*radius*(midAngle(r)<Math.PI?1:-1),"translate("+n+")"}}).styleTween("text-anchor",function(e){this._current=this._current||e;var t=d3.interpolate(this._current,e);return this._current=t(0),function(e){var r=t(e);return midAngle(r)<Math.PI?"start":"end"}}).tween("text",function(e){this._current=this._current||e;var t=d3.interpolate(this._current,e);return this._current=t(0),function(e){var r=t(e);this.textContent=Math.round(r.value)+" 席"}}),r.exit().remove()}function renderTextPolylines(e,t){var r=e.select(".lines").selectAll("polyline").data(pie(t),function(e){return e.data.key});r.enter().append("polyline"),r.transition().duration(1e3).attrTween("points",function(e){this._current=this._current||e;var t=d3.interpolate(this._current,e);return this._current=t(0),function(e){var r=t(e),n=outerArc.centroid(r);return n[0]=.9*radius*(midAngle(r)<Math.PI?1:-1),[innerArc.centroid(r),outerArc.centroid(r),n]}}),r.exit().remove()}function renderLegends(e,t,r){var n={w:75,h:30,s:3,r:3},a=d3.select(e).select("svg");a.empty()&&(a=d3.select(e).append("svg").attr("width",d3.keys(t).length*(n.w+n.s)).attr("height",n.h)),a=a.selectAll("g").data(d3.entries(r)).enter().append("g").attr("transform",function(e,t){return"translate("+t*(n.w+n.s)+", 0)"}),a.append("rect").attr("rx",n.r).attr("ry",n.r).attr("width",n.w).attr("height",n.h).style("fill",function(e){return e.value}),a.append("text").data(d3.entries(t)).attr("x",n.w/2).attr("y",n.h/2).attr("dy",".35em").attr("text-anchor","middle").text(function(e){return e.value})}function getChoice(e){switch(e){case 0:case 1:case 2:return e;default:return 3}}function renderChart1(e){width=$("#chart-1").width(),height=.75*width,radius=Math.min(width,height)/2,innerArc=d3.svg.arc().innerRadius(.5*radius).outerRadius(.8*radius),outerArc=d3.svg.arc().innerRadius(.9*radius).outerRadius(.9*radius);var t=d3.select("#chart-1").select("#body-chart-1").style("width",width).style("height",height).select("g");t.empty()&&(t=d3.select("#chart-1").append("svg").attr("id","body-chart-1").style("width",width).style("height",height).append("g")),t.selectAll(".slices").data([null]).enter().append("g").attr("class","slices"),t.selectAll(".labels").data([null]).enter().append("g").attr("class","labels"),t.selectAll(".lines").data([null]).enter().append("g").attr("class","lines"),t.attr("transform","translate("+width/2+", "+height/2+")");var r=d3.nest().key(function(e){return e.choice=getChoice(e.choice),e.choice}).rollup(function(e){return{object:e,length:e.length}}).entries(e);renderPieChart(t,r),renderLegends("#legend-chart-1",textLabels,sliceColors)}var url="https://csasa-petition.firebaseio.com/",app=angular.module("app",["legislatorFilters","stringFilters","firebase"]);app.service("authService",["$firebaseSimpleLogin",function(e){var t=new Firebase(url+"/auth");return{getHandler:function(){return e(t)},log:function(e){return $firebase(t).$child("log").$add(e)}}}]),app.service("dataService",["$firebase",function(e){var t=new Firebase(url+"/data");return e(t)}]),app.controller("ChartCtrl",["$scope","$window","dataService",function(e,t,r){r.$on("value",function(e){renderChart1(e.snapshot.value),angular.element(t).bind("resize",function(){renderChart1(e.snapshot.value)})})}]),app.controller("LegislatorListCtrl",["$scope","authService","dataService",function(e,t,r){r.$bind(e,"legislators"),e.auth=t.getHandler(),e.choose=function(n,a){"undefined"!=typeof a&&r.$child(n).$update({choice:a}).then(function(){t.log({user:e.auth.user,legislator:n,choice:a,timestamp:(new Date).getTime()})},function(e){"PERMISSION_DENIED"==e.code})}}]),app.controller("AuthCtrl",["$scope","authService",function(e,t){e.auth=t.getHandler(),e.checkAuth=function(){e.auth.$getCurrentUser().then(function(e){null===e&&$("#auth-panel").modal("show")},function(){})},e.login=function(t,r){e.auth.$login(t,r),$("#auth-panel").modal("hide")},e.logout=function(){e.auth.$logout()},e.getAvatar=function(){if(null===e.auth.user)return null;switch(e.auth.user.provider){case"facebook":return null;case"github":return e.auth.user.avatar_url;case"google":return e.auth.user.thirdPartyUserData.picture;case"twitter":return e.auth.user.profile_image_url_https;default:return null}}}]);var passcodeQueue=[],ma_avatar="http://image.kmt.org.tw/people/20090606164842.jpg";app.directive("ngPasscode",[function(){return function(e,t){t.bind("keypress",function(e){0===passcodeQueue.length&&setTimeout(function(){passcodeQueue=[]},1e3),passcodeQueue.push(e.which),checkKeyStrokes(passcodeQueue,[97,97,98,98,97,98,99])&&$(".party-KMT .avatar img").attr("width",128).attr("src",ma_avatar)})}}]);var width,height,radius,innerArc,outerArc,sliceColors={0:"#ea0000",1:"#014fbb",2:"#999999",3:"#d9d9d9"},textLabels={0:"不支持",1:"支持",2:"不表態",3:"尚未表態"},pie=d3.layout.pie().sort(null).value(function(e){return e.values.length});angular.module("legislatorFilters",[]).filter("toEmblem",function(){return function(e){switch(e){case"KMT":return"img/kmt.svg";case"DPP":return"img/dpp.svg";case"TSU":return"img/tsu.png";case"PFP":return"img/pfp.svg";case"NSU":return"img/nsu.svg";default:return"img/ic.svg"}}}).filter("toTextLabel",function(){return function(e){switch(e){case 0:return"不支持";case 1:return"支持";case 2:return"不表態";default:return"尚未表態"}}}).filter("choiceClass",function(){return function(e){switch(e){case 0:case 1:case 2:break;default:return"choice-unknown"}}}),angular.module("stringFilters",[]).filter("strip",function(){return function(e,t){var r=new RegExp(t);return e.replace(r,"")}}).filter("default",function(){return function(e,t){return null==e|""==e?t:e}});